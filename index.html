<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa do Porto – Freguesias + Pins</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .controls {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: rgba(255,255,255,0.95); padding: 10px; border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,.15); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      max-width: 360px;
    }
    .controls h3 { margin: 0 0 6px; font-size: 16px; }
    .controls label { display: block; font-size: 12px; margin-top: 8px; }
    .controls input, .controls textarea, .controls select { width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 8px; font-size: 12px; }
    .controls button { margin-top: 8px; padding: 8px 10px; border: 0; border-radius: 8px; cursor: pointer; }
    .btn { background:#111; color:#fff; }
    .btn-secondary { background:#f0f0f0; color:#111; }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; background:#111; color:#fff; font-size:10px; margin-left:6px; }
    .legend { position:absolute; right:10px; bottom:10px; z-index:1000; background:rgba(255,255,255,0.95); padding:10px; border-radius:10px; box-shadow: 0 4px 16px rgba(0,0,0,.15); font-size:12px; }
    .freg-label { background: rgba(255,255,255,0.85); border-radius: 6px; padding: 2px 6px; border: 1px solid #ddd; font-weight: 600; }
  </style>
</head>
<body>
  <div class="controls">
    <h3>Mapa do Porto <span class="badge">Freguesias</span></h3>
    <div>
      <label>Adicionar Pin (clique no mapa e preencha):</label>
      <label>Nome do empreendimento</label>
      <input type="text" id="pinName" placeholder="Ex.: Gramoínhos Living" />
      <label>Notas / Fase</label>
      <textarea id="pinNotes" rows="2" placeholder="Em construção; T2/T3; promotor X"></textarea>
      <button class="btn" id="enableAdd">Ativar modo &quot;Adicionar Pin&quot;</button>
      <button class="btn-secondary" id="disableAdd">Desativar</button>
    </div>
    <div>
      <label>Importar pins (GeoJSON/CSV)</label>
      <input type="file" id="fileInput" accept=".json,.geojson,.csv" />
      <button class="btn-secondary" id="clearPins">Limpar pins</button>
      <button class="btn" id="exportPins">Exportar pins (GeoJSON)</button>
    </div>
    <div>
      <label>Mostrar rótulos das freguesias</label>
      <select id="labelsToggle">
        <option value="on">Sim</option>
        <option value="off">Não</option>
      </select>
    </div>
  </div>
  <div id="map"></div>
  <div class="legend">
    <strong>Fontes:</strong><br/> OpenStreetMap; Limites freguesias via Águas do Porto (ArcGIS GeoJSON)
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // Inicialização do mapa centrado no Porto
    const map = L.map('map', { preferCanvas: true }).setView([41.1496, -8.6109], 12);

    // Camada base OSM
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">Contribuidores do OpenStreetMap</a>'
    }).addTo(map);

    // Grupo para pins
    const pins = L.featureGroup().addTo(map);

    // Estado de adição de pins
    let addMode = false;
    const pinNameEl = document.getElementById('pinName');
    const pinNotesEl = document.getElementById('pinNotes');

    document.getElementById('enableAdd').onclick = () => { addMode = true; };
    document.getElementById('disableAdd').onclick = () => { addMode = false; };

    map.on('click', (e) => {
      if (!addMode) return;
      const name = pinNameEl.value.trim() || 'Empreendimento';
      const notes = pinNotesEl.value.trim() || '';
      const marker = L.marker(e.latlng, { draggable: true });
      marker.bindPopup(`<strong>${name}</strong><br>${notes}<br><small>${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}</small>`);
      marker.on('dragend', () => marker.openPopup());
      pins.addLayer(marker);
      marker.openPopup();
    });

    // Importar pins (GeoJSON ou CSV com colunas: name,notes,lat,lng)
    document.getElementById('fileInput').addEventListener('change', (evt) => {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        try {
          if (file.name.toLowerCase().endsWith('.csv')) {
            const rows = text.split(/\r?\n/).filter(r => r.trim().length);
            const headers = rows.shift().split(',').map(h => h.trim().toLowerCase());
            const iName = headers.indexOf('name');
            const iNotes = headers.indexOf('notes');
            const iLat = headers.indexOf('lat');
            const iLng = headers.indexOf('lng');
            rows.forEach(r => {
              const cols = r.split(',');
              const lat = parseFloat(cols[iLat]);
              const lng = parseFloat(cols[iLng]);
              const name = cols[iName] || 'Empreendimento';
              const notes = cols[iNotes] || '';
              if (!isNaN(lat) && !isNaN(lng)) {
                const m = L.marker([lat, lng], { draggable:true }).bindPopup(`<strong>${name}</strong><br>${notes}`);
                pins.addLayer(m);
              }
            });
            if (pins.getLayers().length) map.fitBounds(pins.getBounds(), { padding: [40,40] });
          } else {
            const geo = JSON.parse(text);
            const gj = L.geoJSON(geo, {
              pointToLayer: (f, latlng) => L.marker(latlng, { draggable: true }).bindPopup(`<strong>${f.properties?.name || 'Empreendimento'}</strong><br>${f.properties?.notes || ''}`)
            });
            pins.addLayer(gj);
            if (pins.getLayers().length) map.fitBounds(pins.getBounds(), { padding: [40,40] });
          }
        } catch(err) { alert('Erro a importar: ' + err.message); }
      };
      reader.readAsText(file);
    });

    document.getElementById('clearPins').onclick = () => { pins.clearLayers(); };

    // Exportar pins para GeoJSON
    document.getElementById('exportPins').onclick = () => {
      const fc = pins.toGeoJSON();
      const blob = new Blob([JSON.stringify(fc, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'pins-porto.geojson'; a.click();
      URL.revokeObjectURL(url);
    };

    // Carregar limites das freguesias (ArcGIS Águas do Porto) em GeoJSON
    const freguesiasUrl = 'https://arcgis.aguasdoporto.pt/arcgis/rest/services/Porto_mais_permeavel/Porto_mais_permeavel/MapServer/7/query?where=1%3D1&outFields=*&f=geojson';

    let labelLayer = L.layerGroup();

    fetch(freguesiasUrl)
      .then(r => r.json())
      .then(geo => {
        const freguesias = L.geoJSON(geo, {
          style: {
            color: '#111', weight: 1.5, fillColor: '#4CC9F0', fillOpacity: 0.08
          },
          onEachFeature: (feature, layer) => {
            const nome = feature.properties?.FREGUESIA || feature.properties?.NOME || 'Freguesia';
            layer.bindPopup(`<strong>${nome}</strong>`);
          }
        }).addTo(map);

        // Rótulos (centroides aproximados por bbox)
        labelLayer = L.layerGroup();
        geo.features.forEach(feat => {
          const nome = feat.properties?.FREGUESIA || feat.properties?.NOME || 'Freguesia';
          const coords = feat.geometry.coordinates.flat(2);
          let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
          for (let i=0;i<coords.length;i+=2){
            const x=coords[i], y=coords[i+1];
            if (x<minX) minX=x; if (x>maxX) maxX=x; if (y<minY) minY=y; if (y>maxY) maxY=y;
          }
          const cx=(minY+maxY)/2, cy=(minX+maxX)/2; // GeoJSON: [lng, lat]
          const label = L.marker([cx, cy], { interactive:false, opacity:0.0 });
          label.bindTooltip(nome, { permanent:true, direction:'center', className:'freg-label' }).openTooltip();
          labelLayer.addLayer(label);
        });
        labelLayer.addTo(map);

        map.fitBounds(freguesias.getBounds(), { padding: [20,20] });
      })
      .catch(err => console.error('Falha ao carregar freguesias:', err));

    // Alternar rótulos
    document.getElementById('labelsToggle').addEventListener('change', (e) => {
      if (e.target.value === 'on') { labelLayer.addTo(map); } else { map.removeLayer(labelLayer); }
    });
  </script>
</body>
</html>
