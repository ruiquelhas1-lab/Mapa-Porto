<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Garvetur Luxury Porto ‚Äî Mapa v4.2</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root { --panel:#ffffff; --shadow:0 6px 24px rgba(0,0,0,.12); --radius:12px; --brand:#bfa06a; --dark:#111; }
    html, body { height:100%; margin:0; background:#f5efe6 }
    #map { position:absolute; inset:0; height:100%; width:100%; }
    .controls { position:absolute; top:12px; left:12px; z-index:1000; background:var(--panel); padding:12px; border-radius:var(--radius); box-shadow:var(--shadow); font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; max-width:680px; border:1px solid #eee }
    .controls strong { color:var(--dark) }
    .controls label { display:block; font-size:12px; margin-top:8px }
    .controls input, .controls select, .controls textarea { width:100%; padding:6px 8px; border:1px solid #ddd; border-radius:8px; font-size:12px }
    .controls button { margin-top:8px; padding:8px 10px; border:0; border-radius:10px; cursor:pointer; background:#111; color:#fff }
    .toolbar { position:absolute; right:12px; top:12px; z-index:1000; display:flex; gap:8px; flex-wrap:wrap }
    .toolbar button { background:#fff; border:1px solid #eee; border-radius:10px; padding:8px 10px; box-shadow:0 6px 24px rgba(0,0,0,.12); cursor:pointer }
    .legend { position:absolute; right:12px; bottom:12px; z-index:1000; background:#fff; border:1px solid #eee; border-radius:12px; box-shadow:0 6px 24px rgba(0,0,0,.12); padding:10px; font-family:system-ui; font-size:12px }
    .chip { display:inline-flex; align-items:center; gap:6px; border:1px solid #eee; border-radius:999px; padding:4px 8px; margin-right:6px; background:#fff; cursor:pointer; user-select:none }
    .chip input { margin-right:6px }
    .dot { width:10px; height:10px; border-radius:50% }
    .tt { background: rgba(255,255,255,0.92); color:#111; border:1px solid #ddd; border-radius:8px; box-shadow:0 3px 12px rgba(0,0,0,.12); padding:6px 8px; }
    .freg-label { background: rgba(255,255,255,0.85); border-radius: 6px; padding: 2px 6px; border: 1px solid #ddd; font-weight: 600 }
    .row { display:flex; gap:8px; align-items:center }
    .row > * { flex:1 }
    .status-bar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
    .stats { font-size:12px; color:#333; margin-top:6px }
  </style>
</head>
<body>
  <div class="controls">
    <strong>Mapa do Porto</strong> ‚Äî Importa <b>XLSX</b>, <b>CSV</b> (v√≠rgula ou ;) e <b>GeoJSON</b>.<br/>
    <small>Pesquisa por <strong>Nome</strong>, filtro por <strong>AnoConclusao</strong> e <strong>filtros de Estado</strong>. Etiquetas fixas mostram <em>Nome + Notas + Estado + Ano</em>.</small>

    <div class="row" style="margin-top:8px">
      <div style="flex:2">
        <label>Pesquisar empreendimento (Nome)</label>
        <input id="searchName" list="namesList" placeholder="Escreva e selecione ‚Äî ex.: Men√©res 777" />
        <datalist id="namesList"></datalist>
      </div>
      <div style="flex:1">
        <label>Filtrar por AnoConclusao</label>
        <select id="yearFilter">
          <option value="">‚Äî Todos ‚Äî</option>
        </select>
      </div>
      <div style="flex:0">
        <button id="btnSearch">Ir</button>
      </div>
    </div>

    <div class="status-bar" id="statusBar">
      <label class="chip"><input type="checkbox" value="em_construcao" checked><span class="dot" style="background:#f39c12"></span> Em constru√ß√£o</label>
      <label class="chip"><input type="checkbox" value="em_licenciamento" checked><span class="dot" style="background:#9b59b6"></span> Em licenciamento</label>
      <label class="chip"><input type="checkbox" value="licenciado" checked><span class="dot" style="background:#22a447"></span> Licenciado</label>
      <label class="chip"><input type="checkbox" value="concluido" checked><span class="dot" style="background:#2e86de"></span> Conclu√≠do</label>
    </div>

    <div class="stats" id="stats">0 empreendimentos vis√≠veis.</div>

    <label>Importar ficheiro (XLSX / CSV / GeoJSON)</label>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv,.geojson,.json" />

    <div class="row">
      <div>
        <label>Estado (para adicionar manualmente)</label>
        <select id="pinStatus">
          <option value="licenciado">Licenciado</option>
          <option value="em_licenciamento">Em licenciamento</option>
          <option value="em_construcao" selected>Em constru√ß√£o</option>
          <option value="concluido">Conclu√≠do</option>
        </select>
      </div>
      <div>
        <label>Nome</label><input id="pinName" placeholder="Ex.: Empreendimento" />
      </div>
    </div>
    <label>Notas</label><textarea id="pinNotes" rows="2" placeholder="T2/T3; promotor X"></textarea>
    <div class="row">
      <div><label>AnoConclusao</label><input id="pinYear" type="number" placeholder="2026" /></div>
      <div><label>Link (URL)</label><input id="pinLink" placeholder="https://..." /></div>
      <div><label>TabelaVendas (URL PDF)</label><input id="pinPDF" placeholder="https://.../tabela.pdf" /></div>
    </div>

    <div class="row">
      <button id="enableAdd">Ativar modo ‚ÄúAdicionar Pin‚Äù</button>
      <button id="clearPins" style="background:#f3f3f3;color:#111">Limpar pins</button>
    </div>

    <label>Mostrar r√≥tulos de freguesia</label>
    <select id="labelsToggle"><option value="on">Sim</option><option value="off">N√£o</option></select>
  </div>

  <div class="toolbar">
    <button id="fitBtn">Recentrar</button>
    <button id="switchBase">Alternar base</button>
    <button id="toggleTooltips">Ocultar/Mostrar etiquetas</button>
  </div>

  <div id="map"></div>

  <div class="legend">
    <div class="chip"><span class="dot" style="background:#22a447"></span> Licenciado</div>
    <div class="chip"><span class="dot" style="background:#9b59b6"></span> Em licenciamento</div>
    <div class="chip"><span class="dot" style="background:#f39c12"></span> Em constru√ß√£o</div>
    <div class="chip"><span class="dot" style="background:#2e86de"></span> Conclu√≠do</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // ===== Helpers de normaliza√ß√£o =====
    function normalizeKey(k){
      if(k==null) return '';
      return k.toString().toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // remove acentos
        .replace(/[^a-z0-9]+/g,'') // remove espa√ßos/pontua√ß√£o
        ;
    }
    const KEY_ALIASES = {
      name: ['name','nome','empreendimento','titulo','t√≠tulo'],
      notes: ['notes','notas','descricao','descri√ß√£o','observacoes','observa√ß√µes'],
      status: ['status','estado','fase'],
      lat: ['lat','latitude','y'],
      lng: ['lng','lon','long','longitude','x'],
      ano: ['anoconclusao','ano','anoconclusao','ano_conclusao','conclusao','anodeconclusao','anoconclus√£o']
    };
    function aliasHit(nk, target){ // nk: normalized key map; target: canonical ('name','lat',...)
      const alts = KEY_ALIASES[target] || [target];
      for(const a of alts){
        const na = normalizeKey(a);
        if(nk.has(na)) return nk.get(na);
      }
      return null;
    }
    function normalizeStatus(raw){
      const s = (raw||'').toString().toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/\s+/g,'_');
      if(!s) return 'em_construcao';
      if(s.includes('licenciament')) return 'em_licenciamento';
      if(s.includes('construc')) return 'em_construcao';
      if(s.includes('conclu')) return 'concluido';
      if(s.includes('licenciado')) return 'licenciado';
      if(['licenciado','em_construcao','em_licenciamento','concluido'].includes(s)) return s;
      return s;
    }
    function toYear(v){ const y=parseInt((v||'').toString().trim(),10); return (y>=1900 && y<=2100)? y : null; }
    function toNum(v){ if(v==null) return NaN; v=v.toString().trim().replace(',','.'); return parseFloat(v); }
    function norm(v){ return (v||'').toString().trim(); }
    function sanitizeUrl(u){ try { const url=new URL(u); return url.href; } catch(e){ return ''; } }

    // ===== Base + watchdog =====
    const bases=[
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20,attribution:'&copy; OSM'}),
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:20,attribution:'&copy; OSM & CARTO'}),
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',{maxZoom:19,attribution:'Esri, USGS, NOAA'})
    ];
    const map=L.map('map').setView([41.1496,-8.6109],12); let baseIdx=0; bases[baseIdx].addTo(map);
    function ensureTiles(){ map.invalidateSize(true); setTimeout(()=>map.panBy([0,0]), 50); }
    function switchBase(){ map.removeLayer(bases[baseIdx]); baseIdx=(baseIdx+1)%bases.length; bases[baseIdx].addTo(map); setTimeout(()=>map.invalidateSize(true),50); }
    document.getElementById('switchBase').onclick=()=>switchBase();

    // ===== Layers, estados, √≠ndices =====
    const pins=L.featureGroup().addTo(map);
    const COLORS={licenciado:'#22a447', em_licenciamento:'#9b59b6', em_construcao:'#f39c12', concluido:'#2e86de'};
    let tooltipsVisible=true;
    const markers=[];  // {marker, nameLower, year, status}
    const yearsSet=new Set();
    const selectedStatuses=new Set(['licenciado','em_licenciamento','em_construcao','concluido']);

    function icon(c){const s=encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='28' height='40' viewBox='0 0 28 40'><path d='M14 0C6.268 0 0 6.268 0 14c0 9.333 12.25 24.667 13.016 25.641a1.25 1.25 0 0 0 1.968 0C15.75 38.667 28 23.333 28 14 28 6.268 21.732 0 14 0z' fill='${c}' stroke='rgba(0,0,0,0.35)' stroke-width='1'/><circle cx='14' cy='14' r='5.5' fill='white' stroke='rgba(0,0,0,0.25)'/></svg>`);return L.icon({iconUrl:'data:image/svg+xml;utf8,'+s,iconSize:[28,40],iconAnchor:[14,40],popupAnchor:[0,-34]});}
    function buildTooltipHtml({name,notes,status,ano}){
      const s = (status||'').toString().replace(/_/g,' ');
      const n = (notes||'').toString();
      const y = ano ? `<br><small>Conclus√£o: ${ano}</small>` : '';
      return `<div><strong>${name||'Empreendimento'}</strong>${n?'<br>'+n:''}<br><em>Estado: ${s}</em>${y}</div>`;
    }

    function addPin(lat,lng,{name='Empreendimento',notes='',status='em_construcao',ano=null,link='',pdf=''}={}){
      status = normalizeStatus(status);
      const m=L.marker([lat,lng],{icon:icon(COLORS[status]||COLORS.em_construcao),draggable:true});
      const tth=buildTooltipHtml({name,notes,status,ano});
      m.bindTooltip(tth,{permanent:true,direction:'top',className:'tt',opacity:tooltipsVisible?1:0}).openTooltip();
      const bLink = sanitizeUrl(link) ? `<a href="${sanitizeUrl(link)}" target="_blank" rel="noopener" style="display:inline-block;margin-top:6px;">üîó Ver ficha online</a>` : '';
      const bPDF  = sanitizeUrl(pdf)  ? `<a href="${sanitizeUrl(pdf)}"  target="_blank" rel="noopener" style="display:inline-block;margin-left:10px;margin-top:6px;">üìÑ Tabela de Vendas</a>` : '';
      const year  = ano ? `<br><small>Ano conclus√£o: ${ano}</small>` : '';
      m.bindPopup(`<strong>${name}</strong><br>${notes}<br><small>${status.replace('_',' ')}</small>${year}<br><small>${lat.toFixed(6)}, ${lng.toFixed(6)}</small><br>${bLink}${bPDF}`);
      m.feature={type:'Feature',properties:{name,notes,status,anoConclusao:ano,link:link,pdf:pdf},geometry:{type:'Point',coordinates:[lng,lat]}};
      pins.addLayer(m);
      markers.push({ marker:m, nameLower:(name||'').toString().toLowerCase(), year: ano||null, status });
      if (ano) yearsSet.add(ano);
      return m;
    }

    // ===== Pesquisa por nome =====
    const searchInput=document.getElementById('searchName');
    const namesList=document.getElementById('namesList');
    const btnSearch=document.getElementById('btnSearch');
    function rebuildNameIndex(){
      const seen=new Set(); namesList.innerHTML='';
      markers.forEach(({marker})=>{
        const nm = marker.feature?.properties?.name || 'Empreendimento';
        if(!seen.has(nm)){
          const opt=document.createElement('option'); opt.value=nm; namesList.appendChild(opt);
          seen.add(nm);
        }
      });
    }
    function goToName(){
      const q=(searchInput.value||'').toLowerCase().trim();
      if(!q) return;
      const found = markers.filter(m=>m.nameLower.includes(q)).map(m=>m.marker);
      if(found.length){
        const group=L.featureGroup(found);
        map.fitBounds(group.getBounds(), { padding:[40,40] });
        found[0].openTooltip();
        ensureTiles();
      } else {
        alert('Nenhum empreendimento encontrado para: '+searchInput.value);
      }
    }
    btnSearch.onclick=goToName;
    searchInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); goToName(); }});

    // ===== Filtros =====
    const yearFilter=document.getElementById('yearFilter');
    const stats=document.getElementById('stats');
    function rebuildYearFilter(){
      const years=Array.from(yearsSet.values()).sort((a,b)=>a-b);
      yearFilter.innerHTML = '<option value=\"\">‚Äî Todos ‚Äî</option>' + years.map(y=>`<option value=\"${y}\">${y}</option>`).join('');
    }
    function updateStats(n){ stats.textContent = `${n} empreendimento${n===1?'':'s'} vis√≠veis.`; }
    document.getElementById('statusBar').addEventListener('change', (e)=>{
      if(e.target && e.target.type==='checkbox'){
        const val=e.target.value;
        if(e.target.checked) selectedStatuses.add(val); else selectedStatuses.delete(val);
        applyFilters();
      }
    });
    yearFilter.onchange=()=>applyFilters();

    function applyFilters(){
      const ySel = yearFilter.value ? parseInt(yearFilter.value,10) : null;
      const filtered=[];
      markers.forEach(({marker, year, status})=>{
        const visible = ( (ySel===null || year===ySel) && selectedStatuses.has(status) );
        if(visible){
          if(!pins.hasLayer(marker)) pins.addLayer(marker);
          filtered.push(marker);
        } else {
          if(pins.hasLayer(marker)) pins.removeLayer(marker);
        }
      });
      if(filtered.length){
        const group=L.featureGroup(filtered);
        map.fitBounds(group.getBounds(), { padding:[40,40] });
      }
      updateStats(filtered.length);
      ensureTiles();
    }

    // ===== Importadores com normaliza√ß√£o de cabe√ßalhos =====
    function headersIdxNormalized(rawHeaders, namesWanted){
      const hdrsNorm = rawHeaders.map(h=>normalizeKey(h));
      const wantedNorm = namesWanted.map(n=>normalizeKey(n));
      for(let wn of wantedNorm){
        const i = hdrsNorm.indexOf(wn);
        if(i>-1) return i;
      }
      return -1;
    }

    function parseCSV(txt){
      if (txt.charCodeAt(0)===0xFEFF) txt=txt.slice(1);
      const first=(txt.split(/\r?\n/)[0]||'').trim();
      const sep=(first.split(';').length>first.split(',').length)?';':',';
      const rows=[]; let row=[], field='', q=false;
      for(let i=0;i<txt.length;i++){const c=txt[i],n=txt[i+1]; if(c=='\"'){ if(q&&n=='\"'){ field+='\"'; i++; } else { q=!q; } }
        else if(c===sep && !q){ row.push(field); field=''; }
        else if((c=='\n'||c=='\r') && !q){ if(field!==''||row.length){ row.push(field); rows.push(row); row=[]; field=''; } while(txt[i+1]=='\n'||txt[i+1]=='\r') i++; }
        else { field+=c; } }
      if(field!==''||row.length){ row.push(field); rows.push(row); }
      const headers = rows.shift() || [];
      const iName = headersIdxNormalized(headers, KEY_ALIASES.name);
      const iNotes = headersIdxNormalized(headers, KEY_ALIASES.notes);
      const iStatus= headersIdxNormalized(headers, KEY_ALIASES.status);
      const iLat  = headersIdxNormalized(headers, KEY_ALIASES.lat);
      const iLng  = headersIdxNormalized(headers, KEY_ALIASES.lng);
      const iYear = headersIdxNormalized(headers, KEY_ALIASES.ano);
      if(iLat===-1||iLng===-1) throw new Error('Cabe√ßalhos em falta (lat/latitude e lng/longitude).');
      const out=[];
      for(const r of rows){
        const name = iName>-1? r[iName] : 'Empreendimento';
        const notes = iNotes>-1? r[iNotes] : '';
        const status = normalizeStatus(iStatus>-1? r[iStatus] : 'em_construcao');
        const lat = toNum(r[iLat]), lng = toNum(r[iLng]);
        const ano = iYear>-1 ? toYear(r[iYear]) : null;
        const link = ''; const pdf='';
        if(!isNaN(lat) && !isNaN(lng)) out.push({name,notes,status,lat,lng,ano,link,pdf});
      }
      return out;
    }

    function sheetRowToNormalized(row){
      // Constr√≥i mapa key normalizada -> valor
      const nk = new Map();
      Object.keys(row).forEach(k=> nk.set(normalizeKey(k), row[k]));
      const name = aliasHit(nk,'name') ?? '';
      const notes= aliasHit(nk,'notes') ?? '';
      const status= aliasHit(nk,'status') ?? 'em_construcao';
      const lat = toNum(aliasHit(nk,'lat'));
      const lng = toNum(aliasHit(nk,'lng'));
      const ano = toYear(aliasHit(nk,'ano'));
      // extras opcionais
      const link = row['Link'] || row['link'] || row['URL'] || row['url'] || '';
      const pdf  = row['TabelaVendas'] || row['tabelavendas'] || row['PDF'] || row['pdf'] || '';
      return { name, notes, status: normalizeStatus(status), lat, lng, ano, link, pdf };
    }

    document.getElementById('fileInput').addEventListener('change', (evt)=>{
      const f=evt.target.files[0]; if(!f) return;
      const rdr=new FileReader();
      rdr.onload=(e)=>{
        try{
          const name=f.name.toLowerCase();
          const added=[];
          if(name.endsWith('.geojson')||name.endsWith('.json')){
            const geo=JSON.parse(e.target.result);
            L.geoJSON(geo, { pointToLayer:(feat,latlng)=>{
              const r={
                name:feat.properties?.name||'Empreendimento',
                notes:feat.properties?.notes||'',
                status:normalizeStatus(feat.properties?.status||'em_construcao'),
                ano: toYear(feat.properties?.anoConclusao||feat.properties?.ano||feat.properties?.anoconclusao),
                link: feat.properties?.link||'',
                pdf:  feat.properties?.pdf||feat.properties?.tabelaVendas||''
              };
              added.push(addPin(latlng.lat,latlng.lng,r));
              return null;
            }});
          } else if(name.endsWith('.csv')){
            const rows=parseCSV(e.target.result);
            rows.forEach(r=>added.push(addPin(r.lat,r.lng,r)));
          } else if(name.endsWith('.xlsx')||name.endsWith('.xls')){
            const wb=XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const ws=wb.Sheets[wb.SheetNames[0]]; const json=XLSX.utils.sheet_to_json(ws, {defval:'', raw:false});
            const rows=json.map(sheetRowToNormalized).filter(r=>!isNaN(r.lat)&&!isNaN(r.lng));
            rows.forEach(r=>added.push(addPin(r.lat,r.lng,r)));
          } else {
            alert('Formato n√£o suportado.');
          }
          if(added.length){
            map.fitBounds(L.featureGroup(added).getBounds(),{padding:[40,40]});
            rebuildNameIndex(); rebuildYearFilter(); applyFilters(); ensureTiles();
          }
        } catch(err){ console.error(err); alert('Erro ao importar: '+err.message); }
      };
      if(f.name.toLowerCase().endsWith('.xlsx')||f.name.toLowerCase().endsWith('.xls')) rdr.readAsArrayBuffer(f); else rdr.readAsText(f);
    });

    // ===== Bot√µes e intera√ß√µes =====
    let addMode=false;
    const pinStatus=document.getElementById('pinStatus'), pinName=document.getElementById('pinName'), pinNotes=document.getElementById('pinNotes'),
          pinYear=document.getElementById('pinYear'), pinLink=document.getElementById('pinLink'), pinPDF=document.getElementById('pinPDF');
    document.getElementById('enableAdd').onclick=()=>addMode=!addMode;
    document.getElementById('toggleTooltips').onclick=()=>{
      tooltipsVisible=!tooltipsVisible;
      pins.eachLayer(l=>{ const tt=l.getTooltip(); if(tt){ tt.setOpacity(tooltipsVisible?1:0); } });
    };
    document.getElementById('fitBtn').onclick=()=>{ if(pins.getLayers().length){ map.fitBounds(pins.getBounds(),{padding:[40,40]}); ensureTiles(); } };
    document.getElementById('clearPins').onclick=()=>{ pins.clearLayers(); markers.length=0; yearsSet.clear(); rebuildNameIndex(); rebuildYearFilter(); updateStats(0); };

    // ===== Freguesias =====
    const freguesiasUrl='https://arcgis.aguasdoporto.pt/arcgis/rest/services/Porto_mais_permeavel/Porto_mais_permeavel/MapServer/7/query?where=1%3D1&outFields=*&f=geojson';
    let labelLayer=L.layerGroup();
    fetch(freguesiasUrl).then(r=>r.json()).then(geo=>{
      const freguesias=L.geoJSON(geo,{ style:{ color:'#111', weight:1.5, fillColor:'#bfa06a', fillOpacity:0.06 }, onEachFeature:(feature,layer)=>{ const nome=feature.properties?.FREGUESIA||feature.properties?.NOME||'Freguesia'; layer.bindPopup(`<strong>${nome}</strong>`); } }).addTo(map);
      labelLayer=L.layerGroup();
      (geo.features||[]).forEach(feat=>{
        const nome=feat.properties?.FREGUESIA||feat.properties?.NOME||'Freguesia';
        const coords=(feat.geometry&&feat.geometry.coordinates)||[]; const flat=coords.flat(2);
        let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
        for(let i=0;i<flat.length;i+=2){ const x=flat[i], y=flat[i+1]; if(x<minX)minX=x; if(x>maxX)maxX=x; if(y<minY)minY=y; if(y>maxY)maxY=y; }
        const cx=(minY+maxY)/2, cy=(minX+maxX)/2; const label=L.marker([cx, cy],{ interactive:false, opacity:0.0 });
        label.bindTooltip(nome,{ permanent:true, direction:'center', className:'freg-label' }).openTooltip(); labelLayer.addLayer(label);
      });
      labelLayer.addTo(map);
    }).catch(err=>{ console.warn('Falha a carregar freguesias:', err); });
    document.getElementById('labelsToggle').addEventListener('change',(e)=>{ if(e.target.value==='on'){ labelLayer.addTo(map);} else { map.removeLayer(labelLayer);} });
  </script>
</body>
</html>
